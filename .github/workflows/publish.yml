name: Publish

on:
  workflow_dispatch:
    inputs:
      ref:
        description: Commit SHA or tag to release
        required: true
      tag:
        description: Release tag (e.g. v1.2.3)
        required: true
      title:
        description: Release title
        required: false

permissions:
  contents: write
  actions: read

env:
  BUILD_WORKFLOW_NAME: Build

jobs:
  prepare:
    name: Resolve Build Artifact
    runs-on: ubuntu-latest

    outputs:
      sha: ${{ steps.sha.outputs.sha }}
      build_run_id: ${{ steps.resolve.outputs.build_run_id }}
      need_build: ${{ steps.resolve.outputs.need_build }}

    steps:
      - name: Resolve target SHA
        id: sha
        shell: bash
        run: |
          echo "sha=${{ inputs.ref }}" >> $GITHUB_OUTPUT

      - name: Resolve existing Build run
        id: resolve
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
          TARGET_SHA: ${{ steps.sha.outputs.sha }}
        shell: bash
        run: |
          set -e
          
          # 1. Look for artifact by SHA
          ART_ID=$(gh api repos/$REPO/actions/artifacts \
            -f per_page=50 \
            --jq '.artifacts[]
                  | select(.name | startswith("build-'"$TARGET_SHA"'"))
                  | .id' \
            | head -n 1)
          
          if [ -z "$ART_ID" ]; then
            echo "need_build=true" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # 2. Get the workflow run ID from the artifact
          BUILD_RUN_ID=$(gh api repos/$REPO/actions/artifacts/$ART_ID --jq '.workflow_run.id')
          
          echo "need_build=false" >> $GITHUB_OUTPUT
          echo "artifact_id=$ART_ID" >> $GITHUB_OUTPUT
          echo "build_run_id=$BUILD_RUN_ID" >> $GITHUB_OUTPUT


  build:
    name: Trigger Build (if needed)
    needs: prepare
    if: needs.prepare.outputs.need_build == 'true'
    uses: ./.github/workflows/build.yml
    with:
      ref: ${{ needs.prepare.outputs.sha }}

  release:
    name: Publish Release
    needs: [prepare]
    runs-on: ubuntu-latest

    steps:
      - name: Resolve Build Run ID
        shell: bash
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
        run: |
          if [ "${{ needs.prepare.outputs.need_build }}" = "true" ]; then
            # Build was triggered - find and wait for its workflow run
            TARGET_SHA="${{ needs.prepare.outputs.sha }}"
            
            echo "Waiting for build workflow to start..."
            for i in {1..30}; do
              BUILD_RUN_ID=$(gh api repos/$REPO/actions/workflows/build.yml/runs \
                -f per_page=10 \
                --jq '.workflow_runs[]
                      | select(.head_sha == "'"$TARGET_SHA"'" and .status != "completed")
                      | .id' \
                | head -n 1)
              
              if [ -n "$BUILD_RUN_ID" ]; then
                echo "Found build run: $BUILD_RUN_ID"
                break
              fi
              
              sleep 2
            done
            
            if [ -z "$BUILD_RUN_ID" ]; then
              echo "Error: Could not find build run for SHA $TARGET_SHA"
              exit 1
            fi
            
            # Wait for the build to complete
            echo "Waiting for build run $BUILD_RUN_ID to complete..."
            gh run watch $BUILD_RUN_ID --repo $REPO --exit-status
            
            echo "BUILD_RUN_ID=$BUILD_RUN_ID" >> $GITHUB_ENV
          else
            echo "BUILD_RUN_ID=${{ needs.prepare.outputs.build_run_id }}" >> $GITHUB_ENV
          fi

      - name: Download build artifacts
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
        run: |
          gh run download "$BUILD_RUN_ID" \
            --repo "$REPO" \
            --pattern "build-${{ needs.prepare.outputs.sha }}-*"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ inputs.tag }}
          name: ${{ inputs.title || inputs.tag }}
          prerelease: false
          files: |
            build-*/**
