name: Publish

on:
  workflow_dispatch:
    inputs:
      ref:
        description: Commit SHA or tag to release
        required: true
      tag:
        description: Release tag (e.g. v1.2.3)
        required: true
      title:
        description: Release title
        required: false

permissions:
  contents: write
  actions: read

env:
  BUILD_WORKFLOW_NAME: Build

jobs:
  prepare:
    name: Resolve Build Artifact
    runs-on: ubuntu-latest
    outputs:
      sha: ${{ steps.sha.outputs.sha }}
      build_run_id: ${{ steps.resolve.outputs.build_run_id }}
      need_build: ${{ steps.resolve.outputs.need_build }}

    steps:
      - name: Resolve main HEAD SHA
        id: sha
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
        run: |
          # Use the commit that triggered the workflow, or main HEAD for schedule
          if [ "${{ github.event_name }}" == "push" ]; then
            echo "sha=${{ github.sha }}" >> $GITHUB_OUTPUT
          else
            SHA=$(gh api repos/$REPO/branches/main --jq '.commit.sha')
            echo "sha=$SHA" >> $GITHUB_OUTPUT
          fi

      - name: Resolve existing Build run
        id: resolve
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
          TARGET_SHA: ${{ steps.sha.outputs.sha }}
        run: |
          # Find latest successful run for the commit on 'build.yml'
          # This is more robust than searching artifacts directly
          RUN_ID=$(gh run list --repo $REPO \
            --workflow build.yml \
            --commit $TARGET_SHA \
            --status success \
            --limit 1 \
            --json databaseId \
            --jq '.[0].databaseId')

          if [ -z "$RUN_ID" ]; then
            echo "No existing build found for SHA $TARGET_SHA"
            echo "need_build=true" >> $GITHUB_OUTPUT
          else
            echo "Found existing build run: $RUN_ID"
            echo "need_build=false" >> $GITHUB_OUTPUT
            echo "build_run_id=$RUN_ID" >> $GITHUB_OUTPUT
          fi


  build:
    name: Trigger Build (if needed)
    needs: prepare
    if: needs.prepare.outputs.need_build == 'true'
    uses: ./.github/workflows/build.yml
    with:
      ref: ${{ needs.prepare.outputs.sha }}

  release:
    name: Publish Release
    needs: [prepare]
    runs-on: ubuntu-latest

    steps:
      - name: Resolve Build Run ID
        shell: bash
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
        run: |
          if [ "${{ needs.prepare.outputs.need_build }}" = "true" ]; then
            # Build was triggered - find and wait for its workflow run
            TARGET_SHA="${{ needs.prepare.outputs.sha }}"

            echo "Waiting for build workflow to start..."
            for i in {1..30}; do
              BUILD_RUN_ID=$(gh api repos/$REPO/actions/workflows/build.yml/runs \
                -f per_page=10 \
                --jq '.workflow_runs[]
                      | select(.head_sha == "'"$TARGET_SHA"'" and .status != "completed")
                      | .id' \
                | head -n 1)

              if [ -n "$BUILD_RUN_ID" ]; then
                echo "Found build run: $BUILD_RUN_ID"
                break
              fi

              sleep 2
            done

            if [ -z "$BUILD_RUN_ID" ]; then
              echo "Error: Could not find build run for SHA $TARGET_SHA"
              exit 1
            fi

            # Wait for the build to complete
            echo "Waiting for build run $BUILD_RUN_ID to complete..."
            gh run watch $BUILD_RUN_ID --repo $REPO --exit-status

            echo "BUILD_RUN_ID=$BUILD_RUN_ID" >> $GITHUB_ENV
          else
            echo "BUILD_RUN_ID=${{ needs.prepare.outputs.build_run_id }}" >> $GITHUB_ENV
          fi

      - name: Download build artifacts
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
        run: |
          gh run download "$BUILD_RUN_ID" \
            --repo "$REPO" \
            --pattern "build-${{ needs.prepare.outputs.sha }}-*"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ inputs.tag }}
          name: ${{ inputs.title || inputs.tag }}
          prerelease: false
          files: |
            build-*/**
