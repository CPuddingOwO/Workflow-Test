name: Publish

on:
  workflow_dispatch:
    inputs:
      ref:
        description: Commit SHA or tag to release
        required: true
      tag:
        description: Release tag (e.g. v1.2.3)
        required: true
      title:
        description: Release title
        required: false

permissions:
  contents: write
  actions: read

env:
  BUILD_WORKFLOW_NAME: Build

jobs:
  prepare:
    name: Resolve Build Artifact
    runs-on: ubuntu-latest

    outputs:
      sha: ${{ steps.sha.outputs.sha }}
      build_run_id: ${{ steps.resolve.outputs.build_run_id }}
      need_build: ${{ steps.resolve.outputs.need_build }}

    steps:
      - name: Resolve target SHA
        id: sha
        shell: bash
        run: |
          echo "sha=${{ inputs.ref }}" >> $GITHUB_OUTPUT

      - name: Resolve existing Build run
        id: resolve
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
          TARGET_SHA: ${{ steps.sha.outputs.sha }}
        shell: bash
        run: |
          set -e
          
          # 1. Look for artifact by SHA
          ART_ID=$(gh api repos/$REPO/actions/artifacts \
            -f per_page=50 \
            --jq '.artifacts[]
                  | select(.name | startswith("build-'"$TARGET_SHA"'"))
                  | .id' \
            | head -n 1)
          
          if [ -z "$ART_ID" ]; then
            echo "need_build=true" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo "need_build=false" >> $GITHUB_OUTPUT
          echo "artifact_id=$ART_ID" >> $GITHUB_OUTPUT


  build:
    name: Trigger Build (if needed)
    needs: prepare
    if: needs.prepare.outputs.need_build == 'true'
    uses: ./.github/workflows/build.yml
    with:
      ref: ${{ needs.prepare.outputs.sha }}

  release:
    name: Publish Release
    needs: [prepare, build]
    runs-on: ubuntu-latest

    steps:
      - name: Resolve Build Run ID
        shell: bash
        run: |
          if [ "${{ needs.prepare.outputs.need_build }}" = "true" ]; then
            echo "BUILD_RUN_ID=${{ github.run_id }}" >> $GITHUB_ENV
          else
            echo "BUILD_RUN_ID=${{ needs.prepare.outputs.build_run_id }}" >> $GITHUB_ENV
          fi

      - name: Download build artifacts
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
        run: |
          gh run download "$BUILD_RUN_ID" \
            --repo "$REPO" \
            --pattern "build-${{ needs.prepare.outputs.sha }}-*"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ inputs.tag }}
          name: ${{ inputs.title || inputs.tag }}
          prerelease: false
          files: |
            build-*/**
