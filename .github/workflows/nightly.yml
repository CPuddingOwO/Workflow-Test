name: Nightly

on:
  schedule:
    - cron: "0 2 * * *"
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: write
  actions: read

jobs:
  prepare:
    name: Resolve Build Artifact
    runs-on: ubuntu-latest
    outputs:
      sha: ${{ steps.sha.outputs.sha }}
      build_run_id: ${{ steps.resolve.outputs.build_run_id }}
      need_build: ${{ steps.resolve.outputs.need_build }}

    steps:
      - name: Resolve main HEAD SHA
        id: sha
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
        run: |
          # Use the commit that triggered the workflow, or main HEAD for schedule
          if [ "${{ github.event_name }}" == "push" ]; then
            echo "sha=${{ github.sha }}" >> $GITHUB_OUTPUT
          else
            SHA=$(gh api repos/$REPO/branches/main --jq '.commit.sha')
            echo "sha=$SHA" >> $GITHUB_OUTPUT
          fi

      - name: Resolve existing Build run
        id: resolve
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
          TARGET_SHA: ${{ steps.sha.outputs.sha }}
        run: |
          # Find latest successful run for the commit on 'build.yml'
          # This is more robust than searching artifacts directly
          RUN_ID=$(gh run list --repo $REPO \
            --workflow build.yml \
            --commit $TARGET_SHA \
            --status success \
            --limit 1 \
            --json databaseId \
            --jq '.[0].databaseId')

          if [ -z "$RUN_ID" ]; then
            echo "No existing build found for SHA $TARGET_SHA"
            echo "need_build=true" >> $GITHUB_OUTPUT
          else
            echo "Found existing build run: $RUN_ID"
            echo "need_build=false" >> $GITHUB_OUTPUT
            echo "build_run_id=$RUN_ID" >> $GITHUB_OUTPUT
          fi

  build:
    name: Trigger Build (if needed)
    needs: prepare
    if: needs.prepare.outputs.need_build == 'true'
    uses: ./.github/workflows/build.yml
    with:
      ref: ${{ needs.prepare.outputs.sha }}

  nightly:
    name: Nightly Release
    needs: [prepare, build]
    runs-on: ubuntu-latest
    # Run if prepare succeeded, and build either succeeded (ran) or was skipped (already built)
    if: always() && needs.prepare.result == 'success' && (needs.build.result == 'success' || needs.build.result == 'skipped')

    steps:
      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          # If 'build' job was skipped, we download from the found external run ID.
          # If 'build' job ran, we download from the current workflow run (github.run_id).
          run-id: ${{ needs.build.result == 'skipped' && needs.prepare.outputs.build_run_id || github.run_id }}
          pattern: "build-${{ needs.prepare.outputs.sha }}-*"
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Delete old Nightly Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
        run: |
          echo "Deleting existing 'nightly' release and tag..."
          # Deleting the release with --cleanup-tag removes both the release and the tag.
          # This effectively cleans up all old artifacts.
          gh release delete nightly --repo $REPO --cleanup-tag -y || true

      - name: Create Nightly Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: nightly
          target_commitish: ${{ needs.prepare.outputs.sha }}
          name: Nightly Build ${{ needs.prepare.outputs.sha }}
          body: "Nightly build for commit ${{ needs.prepare.outputs.sha }}"
          prerelease: true
          files: |
            build-*/**